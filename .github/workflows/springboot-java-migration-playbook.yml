name: Spring Boot 4 - Java 25 Migration (Playbook)
on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: 'Target Repository (e.g., org/app-1)'
        required: true
        type: string
      migration_scope:
        description: 'Migration scope (full, build-files-only, imports-only, test-fixes-only, config-only, deploy-only, custom)'
        required: false
        type: choice
        default: 'full'
        options:
          - full
          - build-files-only
          - imports-only
          - test-fixes-only
          - config-only
          - deploy-only
          - custom
      custom_instructions:
        description: 'Custom instructions (only used when scope is "custom")'
        required: false
        type: string
        default: ''

jobs:
  create-migration-issue:
    runs-on: ubuntu-latest
    outputs:
      playbook_summary_url: ${{ steps.prepare-issue.outputs.playbook_summary_url }}
    steps:
      - name: "ðŸ“¥ Checkout Migration Repository"
        uses: actions/checkout@v4

      - name: "ðŸ·ï¸ Ensure Labels and Prepare Migration Issue"
        id: prepare-issue
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Processing target repository: $TARGET_REPO"

          # 1. Load parent POM configuration from config file
          echo "Loading parent POM configuration..."

          # Parse YAML config (using yq if available, fallback to grep/sed)
          if command -v yq &> /dev/null; then
            PARENT_OWNER=$(yq eval '.parent_pom.owner' config/parent-pom-config.yml)
            PARENT_REPO=$(yq eval '.parent_pom.repository' config/parent-pom-config.yml)
            PARENT_GROUP_ID=$(yq eval '.parent_pom.groupId' config/parent-pom-config.yml)
            PARENT_ARTIFACT_ID=$(yq eval '.parent_pom.artifactId' config/parent-pom-config.yml)
            PARENT_VERSION=$(yq eval '.parent_pom.version' config/parent-pom-config.yml)
          else
            # Fallback: simple grep/sed parsing
            PARENT_OWNER=$(grep "owner:" config/parent-pom-config.yml | sed 's/.*owner: *"\(.*\)".*/\1/')
            PARENT_REPO=$(grep "repository:" config/parent-pom-config.yml | sed 's/.*repository: *"\(.*\)".*/\1/')
            PARENT_GROUP_ID=$(grep "groupId:" config/parent-pom-config.yml | sed 's/.*groupId: *"\(.*\)".*/\1/')
            PARENT_ARTIFACT_ID=$(grep "artifactId:" config/parent-pom-config.yml | sed 's/.*artifactId: *"\(.*\)".*/\1/')
            PARENT_VERSION=$(grep "version:" config/parent-pom-config.yml | head -1 | sed 's/.*version: *"\(.*\)".*/\1/')
          fi

          echo "Parent POM Configuration:"
          echo "  Owner: $PARENT_OWNER"
          echo "  Repository: $PARENT_REPO"
          echo "  GroupId: $PARENT_GROUP_ID"
          echo "  ArtifactId: $PARENT_ARTIFACT_ID"
          echo "  Version: $PARENT_VERSION"
          echo "  GitHub Packages URL: https://maven.pkg.github.com/$PARENT_OWNER/$PARENT_REPO"

          # 2. Create labels via REST API (no git repo needed)
          for LABEL_INFO in "migration:0E8A16:Spring Boot migration task" "java-25:1D76DB:Java 25 upgrade"; do
            NAME=$(echo "$LABEL_INFO" | cut -d: -f1)
            COLOR=$(echo "$LABEL_INFO" | cut -d: -f2)
            DESC=$(echo "$LABEL_INFO" | cut -d: -f3)
            gh api "repos/${TARGET_REPO}/labels" \
              --method POST \
              -f name="$NAME" \
              -f color="$COLOR" \
              -f description="$DESC" 2>/dev/null || \
            echo "Label '$NAME' already exists â€” OK"
          done

          # 4. Create issue body (short to stay under 64k token limit with inlined playbook)
          cat > final-issue.md << ISSUE_EOF
          # Migration Task: Spring Boot 4 + Java 25

          **For Copilot:** Use **only** the playbook inlined below. Do **not** fetch or load any other file. Single pass: apply rules from the playbook below, then compile, test, generate \`MIGRATION_SUMMARY.md\`.

          ## Setup (brief)

          Parent POM from GitHub Packages. Create \`~/.m2/settings.xml\` with server id=github (GITHUB_ACTOR, GITHUB_TOKEN) and repository \`https://maven.pkg.github.com/$PARENT_OWNER/$PARENT_REPO\`. Then: \`mvn dependency:get -Dartifact=$PARENT_GROUP_ID:$PARENT_ARTIFACT_ID:$PARENT_VERSION:pom\` and \`mvn clean compile\`.

          **Parent:** $PARENT_GROUP_ID:$PARENT_ARTIFACT_ID:$PARENT_VERSION

          ## Required output

          Create \`MIGRATION_SUMMARY.md\` in repo root: changed files, parent POM change, build/test results, skipped steps, risks.
          ISSUE_EOF

          # 4b. Migration plan header
          cat >> final-issue.md << ISSUE_EOF2

          ---

          ## Migration Plan

          **Scope: \`${{ inputs.migration_scope || 'full' }}\`**

          ISSUE_EOF2

          # 5a. Add scope-specific instructions (single-pass to keep execution fast)
          SCOPE="${{ inputs.migration_scope || 'full' }}"
          case "$SCOPE" in
            full)
              echo "**Single pass:** Apply all Sections 1â€“9 from the playbook below (then C1â€“C7 if applicable). Then: compile, run tests, generate MIGRATION_SUMMARY.md." >> final-issue.md
              ;;
            build-files-only)
              echo "**Single pass:** Apply ONLY Sections 1â€“3 from the playbook below. Then compile and generate MIGRATION_SUMMARY.md." >> final-issue.md
              ;;
            imports-only)
              echo "**Single pass:** Apply ONLY Sections 4â€“5 from the playbook below. Then compile and generate MIGRATION_SUMMARY.md." >> final-issue.md
              ;;
            test-fixes-only)
              echo "**Single pass:** Apply ONLY Section 6 from the playbook below. Then run tests and generate MIGRATION_SUMMARY.md." >> final-issue.md
              ;;
            config-only)
              echo "**Single pass:** Apply ONLY Sections 7â€“8 from the playbook below. Then compile and generate MIGRATION_SUMMARY.md." >> final-issue.md
              ;;
            deploy-only)
              echo "**Single pass:** Apply ONLY Section 9 from the playbook below. Then generate MIGRATION_SUMMARY.md." >> final-issue.md
              ;;
            custom)
              echo "**Custom instructions:**" >> final-issue.md
              echo "${{ inputs.custom_instructions }}" >> final-issue.md
              echo "Single pass: apply as above, then compile/test and generate MIGRATION_SUMMARY.md." >> final-issue.md
              ;;
          esac
          echo "" >> final-issue.md

          # 5. Inline playbook summary (no fetch â€” keeps prompt under 64k tokens)
          PLAYBOOK_SUMMARY_RAW="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/raw/${GITHUB_REF_NAME}/migration-playbook-summary.md"
          echo "" >> final-issue.md
          echo "## Playbook (inlined â€” use this only; do not fetch any other file)" >> final-issue.md
          echo "" >> final-issue.md
          cat migration-playbook-summary.md >> final-issue.md
          echo "" >> final-issue.md
          echo "---" >> final-issue.md
          echo "*End of playbook. Apply rules above, then compile, test, generate MIGRATION_SUMMARY.md.*" >> final-issue.md

          echo "playbook_summary_url=${PLAYBOOK_SUMMARY_RAW}" >> $GITHUB_OUTPUT

      - name: "ðŸš€ Create Migration Issue"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Creating issue in $TARGET_REPO..."
          SCOPE="${{ inputs.migration_scope || 'full' }}"
          gh issue create \
            --repo "$TARGET_REPO" \
            --title "Maintenance: Migrate to Spring Boot 4 & Java 25 [scope: ${SCOPE}]" \
            --body-file final-issue.md \
            --label "migration" \
            --label "java-25"
