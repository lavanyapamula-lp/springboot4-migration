name: Spring Boot 4 - Java 25 Migration (Playbook)
on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: 'Target Repository (e.g., org/app-1)'
        required: true
        type: string
      migration_scope:
        description: 'Migration scope (full, build-files-only, imports-only, test-fixes-only, config-only, deploy-only, custom)'
        required: false
        type: choice
        default: 'full'
        options:
          - full
          - build-files-only
          - imports-only
          - test-fixes-only
          - config-only
          - deploy-only
          - custom
      custom_instructions:
        description: 'Custom instructions (only used when scope is "custom")'
        required: false
        type: string
        default: ''

jobs:
  create-migration-issue:
    runs-on: ubuntu-latest
    outputs:
      playbook_summary_url: ${{ steps.prepare-issue.outputs.playbook_summary_url }}
    steps:
      - name: "ðŸ“¥ Checkout Migration Repository"
        uses: actions/checkout@v4

      - name: "ðŸ·ï¸ Ensure Labels and Prepare Migration Issue"
        id: prepare-issue
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Processing target repository: $TARGET_REPO"

          # 1. Load parent POM configuration from config file
          echo "Loading parent POM configuration..."

          # Parse YAML config (using yq if available, fallback to grep/sed)
          if command -v yq &> /dev/null; then
            PARENT_OWNER=$(yq eval '.parent_pom.owner' config/parent-pom-config.yml)
            PARENT_REPO=$(yq eval '.parent_pom.repository' config/parent-pom-config.yml)
            PARENT_GROUP_ID=$(yq eval '.parent_pom.groupId' config/parent-pom-config.yml)
            PARENT_ARTIFACT_ID=$(yq eval '.parent_pom.artifactId' config/parent-pom-config.yml)
            PARENT_VERSION=$(yq eval '.parent_pom.version' config/parent-pom-config.yml)
          else
            # Fallback: simple grep/sed parsing
            PARENT_OWNER=$(grep "owner:" config/parent-pom-config.yml | sed 's/.*owner: *"\(.*\)".*/\1/')
            PARENT_REPO=$(grep "repository:" config/parent-pom-config.yml | sed 's/.*repository: *"\(.*\)".*/\1/')
            PARENT_GROUP_ID=$(grep "groupId:" config/parent-pom-config.yml | sed 's/.*groupId: *"\(.*\)".*/\1/')
            PARENT_ARTIFACT_ID=$(grep "artifactId:" config/parent-pom-config.yml | sed 's/.*artifactId: *"\(.*\)".*/\1/')
            PARENT_VERSION=$(grep "version:" config/parent-pom-config.yml | head -1 | sed 's/.*version: *"\(.*\)".*/\1/')
          fi

          echo "Parent POM Configuration:"
          echo "  Owner: $PARENT_OWNER"
          echo "  Repository: $PARENT_REPO"
          echo "  GroupId: $PARENT_GROUP_ID"
          echo "  ArtifactId: $PARENT_ARTIFACT_ID"
          echo "  Version: $PARENT_VERSION"
          echo "  GitHub Packages URL: https://maven.pkg.github.com/$PARENT_OWNER/$PARENT_REPO"

          # 2. Create labels via REST API (no git repo needed)
          for LABEL_INFO in "migration:0E8A16:Spring Boot migration task" "java-25:1D76DB:Java 25 upgrade"; do
            NAME=$(echo "$LABEL_INFO" | cut -d: -f1)
            COLOR=$(echo "$LABEL_INFO" | cut -d: -f2)
            DESC=$(echo "$LABEL_INFO" | cut -d: -f3)
            gh api "repos/${TARGET_REPO}/labels" \
              --method POST \
              -f name="$NAME" \
              -f color="$COLOR" \
              -f description="$DESC" 2>/dev/null || \
            echo "Label '$NAME' already exists â€” OK"
          done

          # 3. Create Maven settings template for GitHub Packages
          cat > maven-settings-template.xml << 'SETTINGS_EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0">
              <servers>
                  <server>
                      <id>github</id>
                      <username>${env.GITHUB_ACTOR}</username>
                      <password>${env.GITHUB_TOKEN}</password>
                  </server>
              </servers>

              <profiles>
                  <profile>
                      <id>github</id>
                      <repositories>
                          <repository>
                              <id>github</id>
                              <url>https://maven.pkg.github.com/PARENT_OWNER/PARENT_REPO</url>
                              <releases><enabled>true</enabled></releases>
                              <snapshots>
                                  <enabled>true</enabled>
                                  <updatePolicy>always</updatePolicy>
                              </snapshots>
                          </repository>
                      </repositories>
                  </profile>
              </profiles>

              <activeProfiles>
                  <activeProfile>github</activeProfile>
              </activeProfiles>
          </settings>
          SETTINGS_EOF

          # Replace placeholders with actual config values
          sed -i "s|PARENT_OWNER|$PARENT_OWNER|g" maven-settings-template.xml
          sed -i "s|PARENT_REPO|$PARENT_REPO|g" maven-settings-template.xml

          # 4. Create comprehensive issue body with actual parent POM details
          cat > final-issue.md << ISSUE_EOF
          # Migration Task: Spring Boot 4 + Java 25

          Please apply the following migration plan.

          ## ðŸ”§ Setup Required Before Compilation

          The parent POM must be resolved from GitHub Packages. **Before running \`mvn compile\`, create a temporary Maven settings file in runner home (do not commit it):**

          **File: \`~/.m2/settings.xml\` (ephemeral, runtime only)**

          \`\`\`xml
          ISSUE_EOF

          # Insert the settings template with actual values
          cat maven-settings-template.xml >> final-issue.md

          cat >> final-issue.md << ISSUE_EOF2
          \`\`\`

          **Environment Variables Needed:**
          - \`GITHUB_ACTOR\`: Your GitHub username (automatically set in GitHub Actions)
          - \`GITHUB_TOKEN\`: Your GitHub token with \`read:packages\` permission (automatically available)

          **Test parent POM resolution:**
          \`\`\`bash
          export GITHUB_ACTOR="your-username"
          export GITHUB_TOKEN="ghp_your_token_here"
          mvn dependency:get -Dartifact=$PARENT_GROUP_ID:$PARENT_ARTIFACT_ID:$PARENT_VERSION:pom
          \`\`\`

          If this succeeds, proceed with \`mvn -s ~/.m2/settings.xml clean compile\`.

          **Parent POM Details (from config):**
          - **GroupId**: $PARENT_GROUP_ID
          - **ArtifactId**: $PARENT_ARTIFACT_ID
          - **Version**: $PARENT_VERSION
          - **GitHub Packages URL**: https://maven.pkg.github.com/$PARENT_OWNER/$PARENT_REPO

          ## âœ… Required Output File

          Create a file named **\`MIGRATION_SUMMARY.md\`** in the target repository root.

          The summary must include:
          1. Changed files list
          2. Parent POM change details (old -> new)
          3. Build commands executed and results
          4. Test commands executed and results
          5. Any skipped steps and reason
          6. Known risks / manual follow-ups

          If compilation/tests cannot run due to repository access/credentials, still create
          \`MIGRATION_SUMMARY.md\` and document the exact failure and next action.

          ---

          ## Migration Plan

          **Migration Scope: \`${{ inputs.migration_scope || 'full' }}\`**

          ISSUE_EOF2

          # 5a. Add scope-specific instructions
          SCOPE="${{ inputs.migration_scope || 'full' }}"
          case "$SCOPE" in
            full)
              echo "Execute all 9 core phases (Sections 1â€“9) in order, then applicable conditional phases (C1â€“C7)." >> final-issue.md
              ;;
            build-files-only)
              echo "Execute ONLY Sections 1â€“3 (Build Files & Parent POM, Java 25, Modularized Starters). Skip all other sections." >> final-issue.md
              ;;
            imports-only)
              echo "Execute ONLY Sections 4â€“5 (Jackson 2â†’3, Spring Security Updates). Skip all other sections." >> final-issue.md
              ;;
            test-fixes-only)
              echo "Execute ONLY Section 6 (Testing Modernization). Skip all other sections." >> final-issue.md
              ;;
            config-only)
              echo "Execute ONLY Sections 7â€“8 (Config Property Renames, Removed & Deprecated APIs). Skip all other sections." >> final-issue.md
              ;;
            deploy-only)
              echo "Execute ONLY Section 9 (Docker, CI/CD & Validation). Skip all other sections." >> final-issue.md
              ;;
            custom)
              echo "**Custom instructions:**" >> final-issue.md
              echo "${{ inputs.custom_instructions }}" >> final-issue.md
              ;;
          esac
          echo "" >> final-issue.md

          # 5. Add playbook links (summary stays under 64k token limit; full is for reference)
          PLAYBOOK_SUMMARY_BLOB="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_REF_NAME}/migration-playbook-summary.md"
          PLAYBOOK_SUMMARY_RAW="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/raw/${GITHUB_REF_NAME}/migration-playbook-summary.md"
          PLAYBOOK_FULL_BLOB="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_REF_NAME}/migration-playbook.md"
          echo "Adding playbook links (summary + full)"
          # Machine-parseable: automation can grep for PLAYBOOK_SUMMARY_RAW_URL to fetch the summary (stays under 64k tokens)
          echo "" >> final-issue.md
          echo "PLAYBOOK_SUMMARY_RAW_URL=${PLAYBOOK_SUMMARY_RAW}" >> final-issue.md
          echo "" >> final-issue.md
          cat >> final-issue.md << ISSUE_EOF3

          ## Playbook (use summary to stay under token/prompt limits)

          **For automation / AI (64k token limit):** Use the **summary** only. The issue body contains a line \`PLAYBOOK_SUMMARY_RAW_URL=<url>\` â€” fetch that URL as the playbook content.
          - View: ${PLAYBOOK_SUMMARY_BLOB}
          - Raw: ${PLAYBOOK_SUMMARY_RAW}

          **For full rule text (find/replace, validate):** Open when needed per section:
          - Full playbook: ${PLAYBOOK_FULL_BLOB}

          Use this branch (not main).
          ISSUE_EOF3

          # Expose summary URL for any automation that reads workflow outputs
          echo "playbook_summary_url=${PLAYBOOK_SUMMARY_RAW}" >> $GITHUB_OUTPUT

      - name: "ðŸš€ Create Migration Issue"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Creating issue in $TARGET_REPO..."
          SCOPE="${{ inputs.migration_scope || 'full' }}"
          gh issue create \
            --repo "$TARGET_REPO" \
            --title "Maintenance: Migrate to Spring Boot 4 & Java 25 [scope: ${SCOPE}]" \
            --body-file final-issue.md \
            --label "migration" \
            --label "java-25"
