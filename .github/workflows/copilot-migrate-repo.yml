name: Copilot Migration Trigger
on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: 'Target Repository (e.g., org/app-1)'
        required: true
        type: string
jobs:
  trigger-copilot-migration:
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ·ï¸ Ensure Labels and Fetch Playbook"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Processing target repository: $TARGET_REPO"

          # 1. Create labels via REST API (no git repo needed)
          for LABEL_INFO in "migration:0E8A16:Spring Boot migration task" "java-25:1D76DB:Java 25 upgrade"; do
            NAME=$(echo "$LABEL_INFO" | cut -d: -f1)
            COLOR=$(echo "$LABEL_INFO" | cut -d: -f2)
            DESC=$(echo "$LABEL_INFO" | cut -d: -f3)
            gh api "repos/${TARGET_REPO}/labels" \
              --method POST \
              -f name="$NAME" \
              -f color="$COLOR" \
              -f description="$DESC" 2>/dev/null || \
            echo "Label '$NAME' already exists â€” OK"
          done

          # 2. Download the latest Migration Playbook
          PLAYBOOK_URL="https://raw.githubusercontent.com/lavanyapamula-lp/springboot4-migration/main/migration-playbook.md"
          echo "Fetching playbook from: $PLAYBOOK_URL"
          curl -sL "$PLAYBOOK_URL" -o migration-task.md

          # 3. Prepend Copilot instruction
          sed -i '1i # Migration Task\n@copilot please analyze this repository and apply the following migration plan:\n' migration-task.md

      - name: "ðŸš€ Create Migration Issue"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Creating issue in $TARGET_REPO..."
          gh issue create \
            --repo "$TARGET_REPO" \
            --title "Maintenance: Migrate to Spring Boot 4 & Java 25" \
            --body-file migration-task.md \
            --label "migration" \
            --label "java-25"