name: Copilot Migration Trigger
on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: 'Target Repository (e.g., org/app-1)'
        required: true
        type: string
jobs:
  trigger-copilot-migration:
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ·ï¸ Ensure Labels and Fetch Playbook"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Processing target repository: $TARGET_REPO"

          # 1. Create labels via REST API (no git repo needed)
          for LABEL_INFO in "migration:0E8A16:Spring Boot migration task" "java-25:1D76DB:Java 25 upgrade"; do
            NAME=$(echo "$LABEL_INFO" | cut -d: -f1)
            COLOR=$(echo "$LABEL_INFO" | cut -d: -f2)
            DESC=$(echo "$LABEL_INFO" | cut -d: -f3)
            gh api "repos/${TARGET_REPO}/labels" \
              --method POST \
              -f name="$NAME" \
              -f color="$COLOR" \
              -f description="$DESC" 2>/dev/null || \
            echo "Label '$NAME' already exists â€” OK"
          done

          # 2. Download the latest Migration Playbook
          PLAYBOOK_URL="https://raw.githubusercontent.com/Siri1990/springboot4-migration/main/migration-playbook.md"
          echo "Fetching playbook from: $PLAYBOOK_URL"
          curl -sL "$PLAYBOOK_URL" -o migration-task.md

          # 3. Prepend Copilot instruction
          sed -i '1i # Migration Task\n@copilot please analyze this repository and apply the following migration plan:\n' migration-task.md

      - name: "ðŸš€ Create Issue & Assign to Copilot Agent"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          OWNER=$(echo "$TARGET_REPO" | cut -d'/' -f1)
          REPO=$(echo "$TARGET_REPO" | cut -d'/' -f2)

          # 1. Get Copilot bot ID
          COPILOT_ID=$(gh api graphql \
            -H "GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection" \
            -f query="
              query {
                repository(owner: \"${OWNER}\", name: \"${REPO}\") {
                  suggestedActors(first: 1, capabilities: [CAN_BE_ASSIGNED_TO_COPILOT_CODING_AGENT]) {
                    nodes { id login }
                  }
                }
              }
            " --jq '.data.repository.suggestedActors.nodes[0].id')

          if [ -z "$COPILOT_ID" ]; then
            echo "::error::Copilot coding agent not enabled on ${TARGET_REPO}"
            echo "Enable it: Repo Settings â†’ Copilot â†’ Coding agent â†’ Enabled"
            exit 1
          fi
          echo "Copilot agent ID: ${COPILOT_ID}"

          # 2. Get repo ID
          REPO_ID=$(gh api graphql \
            -f query="query { repository(owner: \"${OWNER}\", name: \"${REPO}\") { id } }" \
            --jq '.data.repository.id')

          # 3. Prepare issue body
          ESCAPED_BODY=$(cat migration-task.md | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          # 4. Create issue assigned to Copilot with agent trigger
          RESULT=$(gh api graphql \
            -H "GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection" \
            -f query="
              mutation {
                createIssue(input: {
                  repositoryId: \"${REPO_ID}\",
                  title: \"Maintenance: Migrate to Spring Boot 4 & Java 25\",
                  body: ${ESCAPED_BODY},
                  assigneeIds: [\"${COPILOT_ID}\"],
                  agentAssignment: {
                    targetRepositoryId: \"${REPO_ID}\",
                    baseRef: \"main\",
                    customInstructions: \"Apply the migration playbook from the issue body. Follow every rule precisely.\",
                    customAgent: \"\",
                    model: \"\"
                  }
                }) {
                  issue { number url }
                }
              }
            ")

          ISSUE_URL=$(echo "$RESULT" | jq -r '.data.createIssue.issue.url')
          echo "Issue created and assigned to Copilot: ${ISSUE_URL}"