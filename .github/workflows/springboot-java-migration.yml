name: Spring Boot 4 - Java 25 Migration
on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: 'Target Repository (e.g., org/app-1)'
        required: true
        type: string

jobs:
  create-migration-issue:
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“¥ Checkout Migration Repository"
        uses: actions/checkout@v4

      - name: "ðŸ·ï¸ Ensure Labels and Prepare Migration Issue"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Processing target repository: $TARGET_REPO"

          # 1. Load parent POM configuration from config file
          echo "Loading parent POM configuration..."

          # Parse YAML config (using yq if available, fallback to grep/sed)
          if command -v yq &> /dev/null; then
            PARENT_OWNER=$(yq eval '.parent_pom.owner' config/parent-pom-config.yml)
            PARENT_REPO=$(yq eval '.parent_pom.repository' config/parent-pom-config.yml)
            PARENT_GROUP_ID=$(yq eval '.parent_pom.groupId' config/parent-pom-config.yml)
            PARENT_ARTIFACT_ID=$(yq eval '.parent_pom.artifactId' config/parent-pom-config.yml)
            PARENT_VERSION=$(yq eval '.parent_pom.version' config/parent-pom-config.yml)
          else
            # Fallback: simple grep/sed parsing
            PARENT_OWNER=$(grep "owner:" config/parent-pom-config.yml | sed 's/.*owner: *"\(.*\)".*/\1/')
            PARENT_REPO=$(grep "repository:" config/parent-pom-config.yml | sed 's/.*repository: *"\(.*\)".*/\1/')
            PARENT_GROUP_ID=$(grep "groupId:" config/parent-pom-config.yml | sed 's/.*groupId: *"\(.*\)".*/\1/')
            PARENT_ARTIFACT_ID=$(grep "artifactId:" config/parent-pom-config.yml | sed 's/.*artifactId: *"\(.*\)".*/\1/')
            PARENT_VERSION=$(grep "version:" config/parent-pom-config.yml | head -1 | sed 's/.*version: *"\(.*\)".*/\1/')
          fi

          echo "Parent POM Configuration:"
          echo "  Owner: $PARENT_OWNER"
          echo "  Repository: $PARENT_REPO"
          echo "  GroupId: $PARENT_GROUP_ID"
          echo "  ArtifactId: $PARENT_ARTIFACT_ID"
          echo "  Version: $PARENT_VERSION"
          echo "  GitHub Packages URL: https://maven.pkg.github.com/$PARENT_OWNER/$PARENT_REPO"

          # 2. Create labels via REST API (no git repo needed)
          for LABEL_INFO in "migration:0E8A16:Spring Boot migration task" "java-25:1D76DB:Java 25 upgrade"; do
            NAME=$(echo "$LABEL_INFO" | cut -d: -f1)
            COLOR=$(echo "$LABEL_INFO" | cut -d: -f2)
            DESC=$(echo "$LABEL_INFO" | cut -d: -f3)
            gh api "repos/${TARGET_REPO}/labels" \
              --method POST \
              -f name="$NAME" \
              -f color="$COLOR" \
              -f description="$DESC" 2>/dev/null || \
            echo "Label '$NAME' already exists â€” OK"
          done

          # 3. Create Maven settings template for GitHub Packages
          cat > maven-settings-template.xml << 'SETTINGS_EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0">
              <servers>
                  <server>
                      <id>github</id>
                      <username>${env.GITHUB_ACTOR}</username>
                      <password>${env.GITHUB_TOKEN}</password>
                  </server>
              </servers>

              <profiles>
                  <profile>
                      <id>github</id>
                      <repositories>
                          <repository>
                              <id>github</id>
                              <url>https://maven.pkg.github.com/PARENT_OWNER/PARENT_REPO</url>
                              <releases><enabled>true</enabled></releases>
                              <snapshots>
                                  <enabled>true</enabled>
                                  <updatePolicy>always</updatePolicy>
                              </snapshots>
                          </repository>
                      </repositories>
                  </profile>
              </profiles>

              <activeProfiles>
                  <activeProfile>github</activeProfile>
              </activeProfiles>
          </settings>
          SETTINGS_EOF

          # Replace placeholders with actual config values
          sed -i "s|PARENT_OWNER|$PARENT_OWNER|g" maven-settings-template.xml
          sed -i "s|PARENT_REPO|$PARENT_REPO|g" maven-settings-template.xml

          # 4. Create comprehensive issue body with actual parent POM details
          cat > final-issue.md << ISSUE_EOF
          # Migration Task: Spring Boot 4 + Java 25

          Please apply the following migration plan.

          ## ðŸ”§ Setup Required Before Compilation

          The parent POM must be resolved from GitHub Packages. **Before running \`mvn compile\`, create a temporary Maven settings file in runner home (do not commit it):**

          **File: \`~/.m2/settings.xml\` (ephemeral, runtime only)**

          \`\`\`xml
          ISSUE_EOF

          # Insert the settings template with actual values
          cat maven-settings-template.xml >> final-issue.md

          cat >> final-issue.md << ISSUE_EOF2
          \`\`\`

          **Environment Variables Needed:**
          - \`GITHUB_ACTOR\`: Your GitHub username (automatically set in GitHub Actions)
          - \`GITHUB_TOKEN\`: Your GitHub token with \`read:packages\` permission (automatically available)

          **Test parent POM resolution:**
          \`\`\`bash
          export GITHUB_ACTOR="your-username"
          export GITHUB_TOKEN="ghp_your_token_here"
          mvn dependency:get -Dartifact=$PARENT_GROUP_ID:$PARENT_ARTIFACT_ID:$PARENT_VERSION:pom
          \`\`\`

          If this succeeds, proceed with \`mvn -s ~/.m2/settings.xml clean compile\`.

          **Parent POM Details (from config):**
          - **GroupId**: $PARENT_GROUP_ID
          - **ArtifactId**: $PARENT_ARTIFACT_ID
          - **Version**: $PARENT_VERSION
          - **GitHub Packages URL**: https://maven.pkg.github.com/$PARENT_OWNER/$PARENT_REPO

          ## âœ… Required Output File

          Create a file named **\`MIGRATION_SUMMARY.md\`** in the target repository root.

          The summary must include:
          1. Changed files list
          2. Parent POM change details (old -> new)
          3. Build commands executed and results
          4. Test commands executed and results
          5. Any skipped steps and reason
          6. Known risks / manual follow-ups

          If compilation/tests cannot run due to repository access/credentials, still create
          \`MIGRATION_SUMMARY.md\` and document the exact failure and next action.

          ---

          ## Migration Plan

          ISSUE_EOF2

          # 5. Add branch-specific playbook links
          PLAYBOOK_BLOB_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/${GITHUB_REF_NAME}/migration-playbook.md"
          PLAYBOOK_RAW_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/raw/${GITHUB_REF_NAME}/migration-playbook.md"
          echo "Adding branch-specific playbook links: $PLAYBOOK_BLOB_URL"
          cat >> final-issue.md << ISSUE_EOF3

          The full migration playbook is in this branch:
          - View: ${PLAYBOOK_BLOB_URL}
          - Raw: ${PLAYBOOK_RAW_URL}

          Use this branch-specific playbook (not main).
          ISSUE_EOF3

      - name: "ðŸš€ Create Migration Issue"
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
          TARGET_REPO: ${{ inputs.target_repository }}
        run: |
          echo "Creating issue in $TARGET_REPO..."
          gh issue create \
            --repo "$TARGET_REPO" \
            --title "Maintenance: Migrate to Spring Boot 4 & Java 25" \
            --body-file final-issue.md \
            --label "migration" \
            --label "java-25"
