name: "Spring Boot 4 - Java 25 Migration (Script)"

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Repo to migrate (org/repo)"
        required: true

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Migration Toolkit (this repo)
        uses: actions/checkout@v4
        with:
          path: migration-toolkit

      - name: Load Parent POM config
        id: parent-config
        run: |
          CONFIG="migration-toolkit/config/parent-pom-config.yml"
          if command -v yq &> /dev/null; then
            PARENT_OWNER=$(yq eval '.parent_pom.owner' "$CONFIG")
            PARENT_REPO=$(yq eval '.parent_pom.repository' "$CONFIG")
            PARENT_BRANCH=$(yq eval '.parent_pom.branch' "$CONFIG")
            PARENT_VERSION=$(yq eval '.parent_pom.version' "$CONFIG")
          else
            PARENT_OWNER=$(grep "owner:" "$CONFIG" | sed 's/.*owner: *"\(.*\)".*/\1/')
            PARENT_REPO=$(grep "repository:" "$CONFIG" | sed 's/.*repository: *"\(.*\)".*/\1/')
            PARENT_BRANCH=$(grep "branch:" "$CONFIG" | sed 's/.*branch: *"\(.*\)".*/\1/')
            PARENT_VERSION=$(grep "version:" "$CONFIG" | head -1 | sed 's/.*version: *"\(.*\)".*/\1/')
          fi

          echo "parent_owner=$PARENT_OWNER" >> "$GITHUB_OUTPUT"
          echo "parent_repo=$PARENT_REPO" >> "$GITHUB_OUTPUT"
          echo "parent_branch=$PARENT_BRANCH" >> "$GITHUB_OUTPUT"
          echo "parent_version=$PARENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Checkout Parent Library
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parent-config.outputs.parent_owner }}/${{ steps.parent-config.outputs.parent_repo }}
          ref: ${{ steps.parent-config.outputs.parent_branch }}
          token: ${{ secrets.MIGRATION_PAT }}
          path: parent-library

      # â”€â”€ NEW STEP: Install Parent Library Locally â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Parent POM
        run: |
          cd parent-library
          mvn clean install -N  # -N (Non-recursive) installs just the parent POM fast
          echo "âœ… Installed Parent POM to local .m2 cache"

      - name: Checkout Target App
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.MIGRATION_PAT }}
          path: target-app

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      # â”€â”€ STEP 1: Align build + import rewrites before OpenRewrite â”€â”€â”€â”€â”€â”€
      # This ensures parent resolution and package relocations are in place.
      - name: "ðŸ“– Run migrate.sh (phases 1-2)"
        working-directory: target-app
        run: |
          chmod +x ../migration-toolkit/migrate.sh
          ../migration-toolkit/migrate.sh --phase 1-2

      # â”€â”€ STEP 2: OpenRewrite (AST Transformation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run OpenRewrite
        working-directory: target-app
        run: |
          echo "Using OpenRewrite config from migration toolkit"
          mvn -U org.openrewrite.maven:rewrite-maven-plugin:run \
            -Drewrite.recipeArtifactCoordinates=org.openrewrite.recipe:rewrite-spring:LATEST \
            -Drewrite.configLocation=../migration-toolkit/openrewrite-config.yml \
            -Drewrite.activeRecipes=com.lavanya.migration.SpringBoot4Java25

      # â”€â”€ STEP 3: Run remaining scripted migration phases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ðŸ“– Run migrate.sh (phases 3-6)"
        working-directory: target-app
        run: |
          chmod +x ../migration-toolkit/migrate.sh
          ../migration-toolkit/migrate.sh --phase 3-6

      # â”€â”€ STEP 4: Validation report only (non-blocking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Known Java 25 removals (e.g., Thread.suspend/resume) are surfaced
      # for manual remediation, but should not block PR creation.
      - name: "ðŸ”Ž Run migration validation (report only)"
        working-directory: target-app
        run: |
          chmod +x ../migration-toolkit/migrate.sh
          ../migration-toolkit/migrate.sh --phase 7 --report-only

      - name: Create Pull Request (native git + gh)
        working-directory: target-app
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_PAT }}
        run: |
          set -e

          # Create a deterministic migration branch for this run.
          BRANCH="chore/migrate-sb4-java25-${GITHUB_RUN_ID}"
          git checkout -b "$BRANCH"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes detected after migration. Skipping PR creation."
            exit 0
          fi

          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
            commit -m "chore: migrate to Spring Boot 4 and Java 25"
          git push -u origin "$BRANCH"

          BASE_BRANCH="$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || true)"
          if [ -z "$BASE_BRANCH" ]; then
            BASE_BRANCH="main"
          fi

          gh pr create \
            --repo "${{ inputs.target_repo }}" \
            --head "$BRANCH" \
            --base "$BASE_BRANCH" \
            --title "ðŸš€ Migration: Spring Boot 4 / Java 25" \
            --body "Updated parent to ${{ steps.parent-config.outputs.parent_version }} and applied playbook rules."
